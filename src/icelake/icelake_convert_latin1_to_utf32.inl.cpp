
/* convert_latin1_to_utf32+haswell, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.628 ins/byte,    0.373 cycle/byte,    8.615 GB/s (38.7 %),     3.209 GHz,    1.686 ins/cycle 
   0.628 ins/char,    0.373 cycle/char,    8.615 Gc/s (38.7 %)     1.00 byte/char 
WARNING: Measurements are noisy, try increasing iteration count (-I).
convert_latin1_to_utf32+icelake, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.316 ins/byte,    0.301 cycle/byte,   10.332 GB/s (5.0 %),     3.113 GHz,    1.049 ins/cycle 
   0.316 ins/char,    0.301 cycle/char,   10.332 Gc/s (5.0 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  32.031 ins/byte,    6.020 cycle/byte,    0.531 GB/s (0.3 %),     3.194 GHz,    5.321 ins/cycle 
  32.031 ins/char,    6.020 cycle/char,    0.531 Gc/s (0.3 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  54.842 ins/byte,   10.695 cycle/byte,    0.299 GB/s (8.6 %),     3.193 GHz,    5.128 ins/cycle 
  54.842 ins/char,   10.695 cycle/char,    0.299 Gc/s (8.6 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   1.191 ins/byte,    0.252 cycle/byte,   12.759 GB/s (4.3 %),     3.221 GHz,    4.719 ins/cycle 
   1.191 ins/char,    0.252 cycle/char,   12.759 Gc/s (4.3 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.626 ins/byte,    0.587 cycle/byte,    5.443 GB/s (2.0 %),     3.196 GHz,    1.065 ins/cycle 
   0.626 ins/char,    0.587 cycle/char,    5.443 Gc/s (2.0 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.313 ins/byte,    0.496 cycle/byte,    6.245 GB/s (2.0 %),     3.098 GHz,    0.631 ins/cycle 
   0.313 ins/char,    0.496 cycle/char,    6.245 Gc/s (2.0 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  32.024 ins/byte,    6.026 cycle/byte,    0.530 GB/s (0.5 %),     3.193 GHz,    5.314 ins/cycle 
  32.024 ins/char,    6.026 cycle/char,    0.530 Gc/s (0.5 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  54.798 ins/byte,   10.710 cycle/byte,    0.298 GB/s (6.9 %),     3.189 GHz,    5.117 ins/cycle 
  54.798 ins/char,   10.710 cycle/char,    0.298 Gc/s (6.9 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   1.188 ins/byte,    0.504 cycle/byte,    6.340 GB/s (0.9 %),     3.197 GHz,    2.356 ins/cycle 
   1.188 ins/char,    0.504 cycle/char,    6.340 Gc/s (0.9 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.626 ins/byte,    0.239 cycle/byte,   13.380 GB/s (1.9 %),     3.203 GHz,    2.616 ins/cycle 
   0.626 ins/char,    0.239 cycle/char,   13.380 Gc/s (1.9 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.314 ins/byte,    0.251 cycle/byte,   12.387 GB/s (2.0 %),     3.103 GHz,    1.253 ins/cycle 
   0.314 ins/char,    0.251 cycle/char,   12.387 Gc/s (2.0 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  32.026 ins/byte,    6.016 cycle/byte,    0.531 GB/s (0.3 %),     3.193 GHz,    5.323 ins/cycle 
  32.026 ins/char,    6.016 cycle/char,    0.531 Gc/s (0.3 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  54.809 ins/byte,   10.697 cycle/byte,    0.298 GB/s (9.0 %),     3.193 GHz,    5.124 ins/cycle 
  54.809 ins/char,   10.697 cycle/char,    0.298 Gc/s (9.0 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   1.189 ins/byte,    0.258 cycle/byte,   12.407 GB/s (3.4 %),     3.203 GHz,    4.606 ins/cycle 
   1.189 ins/char,    0.258 cycle/char,   12.407 Gc/s (3.4 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.626 ins/byte,    0.331 cycle/byte,    9.664 GB/s (1.8 %),     3.201 GHz,    1.890 ins/cycle 
   0.626 ins/char,    0.331 cycle/char,    9.664 Gc/s (1.8 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.314 ins/byte,    0.343 cycle/byte,    9.051 GB/s (2.9 %),     3.101 GHz,    0.916 ins/cycle 
   0.314 ins/char,    0.343 cycle/char,    9.051 Gc/s (2.9 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  32.025 ins/byte,    6.025 cycle/byte,    0.530 GB/s (0.4 %),     3.193 GHz,    5.316 ins/cycle 
  32.025 ins/char,    6.025 cycle/char,    0.530 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  54.804 ins/byte,   10.705 cycle/byte,    0.298 GB/s (7.7 %),     3.193 GHz,    5.119 ins/cycle 
  54.804 ins/char,   10.705 cycle/char,    0.298 Gc/s (7.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   1.189 ins/byte,    0.345 cycle/byte,    9.289 GB/s (2.7 %),     3.201 GHz,    3.449 ins/cycle 
   1.189 ins/char,    0.345 cycle/char,    9.289 Gc/s (2.7 %)     1.00 byte/char  */

/* std::pair<const char*, char32_t*> avx512_convert_latin1_to_utf32(const char* buf, size_t len, char32_t* utf32_output) {
    size_t rounded_len = len & ~0xF;  // Round down to nearest multiple of 16
    
    for (size_t i = 0; i < rounded_len; i += 16) { 
        // Load 16 Latin1 characters into a 128-bit register
        __m128i in = _mm_loadu_si128((__m128i*)&buf[i]);
        
        // Zero extend each set of 8 Latin1 characters to 16 32-bit integers using vpmovzxbd
        __m512i out = _mm512_cvtepu8_epi32(in);
        
        // Store the results back to memory
        _mm512_storeu_si512((__m512i*)&utf32_output[i], out);
    }

    // Return pointers pointing to where we left off
    return std::make_pair(buf + rounded_len, utf32_output + rounded_len);
}
 */

/* convert_latin1_to_utf32+haswell, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.628 ins/byte,    0.373 cycle/byte,    8.613 GB/s (41.0 %),     3.210 GHz,    1.685 ins/cycle 
   0.628 ins/char,    0.373 cycle/char,    8.613 Gc/s (41.0 %)     1.00 byte/char 
WARNING: Measurements are noisy, try increasing iteration count (-I).
convert_latin1_to_utf32+icelake, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.223 ins/byte,    0.306 cycle/byte,   10.177 GB/s (5.7 %),     3.115 GHz,    0.730 ins/cycle 
   0.223 ins/char,    0.306 cycle/char,   10.177 Gc/s (5.7 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  32.031 ins/byte,    6.020 cycle/byte,    0.531 GB/s (0.4 %),     3.194 GHz,    5.321 ins/cycle 
  32.031 ins/char,    6.020 cycle/char,    0.531 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  54.839 ins/byte,   10.695 cycle/byte,    0.299 GB/s (7.7 %),     3.193 GHz,    5.127 ins/cycle 
  54.839 ins/char,   10.695 cycle/char,    0.299 Gc/s (7.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   1.191 ins/byte,    0.252 cycle/byte,   12.781 GB/s (4.6 %),     3.217 GHz,    4.732 ins/cycle 
   1.191 ins/char,    0.252 cycle/char,   12.781 Gc/s (4.6 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.626 ins/byte,    0.594 cycle/byte,    5.379 GB/s (1.8 %),     3.196 GHz,    1.053 ins/cycle 
   0.626 ins/char,    0.594 cycle/char,    5.379 Gc/s (1.8 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.220 ins/byte,    0.506 cycle/byte,    6.114 GB/s (1.9 %),     3.096 GHz,    0.434 ins/cycle 
   0.220 ins/char,    0.506 cycle/char,    6.114 Gc/s (1.9 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  32.024 ins/byte,    6.026 cycle/byte,    0.530 GB/s (0.4 %),     3.193 GHz,    5.314 ins/cycle 
  32.024 ins/char,    6.026 cycle/char,    0.530 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  54.797 ins/byte,   10.701 cycle/byte,    0.298 GB/s (8.7 %),     3.189 GHz,    5.121 ins/cycle 
  54.797 ins/char,   10.701 cycle/char,    0.298 Gc/s (8.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   1.188 ins/byte,    0.505 cycle/byte,    6.331 GB/s (0.9 %),     3.197 GHz,    2.353 ins/cycle 
   1.188 ins/char,    0.505 cycle/char,    6.331 Gc/s (0.9 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.626 ins/byte,    0.253 cycle/byte,   12.687 GB/s (2.1 %),     3.210 GHz,    2.476 ins/cycle 
   0.626 ins/char,    0.253 cycle/char,   12.687 Gc/s (2.1 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.220 ins/byte,    0.268 cycle/byte,   11.583 GB/s (3.1 %),     3.106 GHz,    0.821 ins/cycle 
   0.220 ins/char,    0.268 cycle/char,   11.583 Gc/s (3.1 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  32.026 ins/byte,    6.015 cycle/byte,    0.531 GB/s (0.3 %),     3.193 GHz,    5.324 ins/cycle 
  32.026 ins/char,    6.015 cycle/char,    0.531 Gc/s (0.3 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  54.808 ins/byte,   10.692 cycle/byte,    0.299 GB/s (7.7 %),     3.193 GHz,    5.126 ins/cycle 
  54.808 ins/char,   10.692 cycle/char,    0.299 Gc/s (7.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   1.189 ins/byte,    0.271 cycle/byte,   11.834 GB/s (3.0 %),     3.207 GHz,    4.388 ins/cycle 
   1.189 ins/char,    0.271 cycle/char,   11.834 Gc/s (3.0 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.626 ins/byte,    0.343 cycle/byte,    9.343 GB/s (1.8 %),     3.200 GHz,    1.828 ins/cycle 
   0.626 ins/char,    0.343 cycle/char,    9.343 Gc/s (1.8 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.220 ins/byte,    0.354 cycle/byte,    8.759 GB/s (2.7 %),     3.100 GHz,    0.622 ins/cycle 
   0.220 ins/char,    0.354 cycle/char,    8.759 Gc/s (2.7 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  32.025 ins/byte,    6.024 cycle/byte,    0.530 GB/s (0.4 %),     3.193 GHz,    5.317 ins/cycle 
  32.025 ins/char,    6.024 cycle/char,    0.530 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  54.803 ins/byte,   10.701 cycle/byte,    0.298 GB/s (9.0 %),     3.193 GHz,    5.121 ins/cycle 
  54.803 ins/char,   10.701 cycle/char,    0.298 Gc/s (9.0 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   1.189 ins/byte,    0.356 cycle/byte,    8.991 GB/s (2.0 %),     3.201 GHz,    3.338 ins/cycle 
   1.189 ins/char,    0.356 cycle/char,    8.991 Gc/s (2.0 %)     1.00 byte/char  */

/* std::pair<const char*, char32_t*> avx512_convert_latin1_to_utf32(const char* buf, size_t len, char32_t* utf32_output) {
    size_t rounded_len = len & ~0x1F;  // Round down to nearest multiple of 32

    for (size_t i = 0; i < rounded_len; i += 32) {  // Unrolling factor of 2
        // First 16 bytes
        __m128i in1 = _mm_loadu_si128((__m128i*)&buf[i]);
        __m512i out1 = _mm512_cvtepu8_epi32(in1);
        _mm512_storeu_si512((__m512i*)&utf32_output[i], out1);

        // Second 16 bytes
        __m128i in2 = _mm_loadu_si128((__m128i*)&buf[i + 16]);
        __m512i out2 = _mm512_cvtepu8_epi32(in2);
        _mm512_storeu_si512((__m512i*)&utf32_output[i + 16], out2);
    }

    return std::make_pair(buf + rounded_len, utf32_output + rounded_len);
}
 */

/* convert_latin1_to_utf32+haswell, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.628 ins/byte,    0.375 cycle/byte,    8.556 GB/s (40.9 %),     3.210 GHz,    1.674 ins/cycle 
   0.628 ins/char,    0.375 cycle/char,    8.556 Gc/s (40.9 %)     1.00 byte/char 
WARNING: Measurements are noisy, try increasing iteration count (-I).
convert_latin1_to_utf32+icelake, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.317 ins/byte,    0.287 cycle/byte,   10.849 GB/s (8.5 %),     3.113 GHz,    1.105 ins/cycle 
   0.317 ins/char,    0.287 cycle/char,   10.849 Gc/s (8.5 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  32.031 ins/byte,    6.020 cycle/byte,    0.530 GB/s (0.3 %),     3.193 GHz,    5.321 ins/cycle 
  32.031 ins/char,    6.020 cycle/char,    0.530 Gc/s (0.3 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  54.842 ins/byte,   10.704 cycle/byte,    0.298 GB/s (8.1 %),     3.193 GHz,    5.124 ins/cycle 
  54.842 ins/char,   10.704 cycle/char,    0.298 Gc/s (8.1 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   1.191 ins/byte,    0.253 cycle/byte,   12.710 GB/s (4.3 %),     3.218 GHz,    4.704 ins/cycle 
   1.191 ins/char,    0.253 cycle/char,   12.710 Gc/s (4.3 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.626 ins/byte,    0.590 cycle/byte,    5.419 GB/s (1.9 %),     3.196 GHz,    1.061 ins/cycle 
   0.626 ins/char,    0.590 cycle/char,    5.419 Gc/s (1.9 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.313 ins/byte,    0.491 cycle/byte,    6.310 GB/s (1.6 %),     3.097 GHz,    0.638 ins/cycle 
   0.313 ins/char,    0.491 cycle/char,    6.310 Gc/s (1.6 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  32.024 ins/byte,    6.027 cycle/byte,    0.530 GB/s (0.4 %),     3.193 GHz,    5.314 ins/cycle 
  32.024 ins/char,    6.027 cycle/char,    0.530 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  54.798 ins/byte,   10.710 cycle/byte,    0.298 GB/s (7.7 %),     3.189 GHz,    5.116 ins/cycle 
  54.798 ins/char,   10.710 cycle/char,    0.298 Gc/s (7.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   1.188 ins/byte,    0.490 cycle/byte,    6.529 GB/s (0.8 %),     3.197 GHz,    2.427 ins/cycle 
   1.188 ins/char,    0.490 cycle/char,    6.529 Gc/s (0.8 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.626 ins/byte,    0.291 cycle/byte,   11.032 GB/s (2.4 %),     3.208 GHz,    2.154 ins/cycle 
   0.626 ins/char,    0.291 cycle/char,   11.032 Gc/s (2.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.314 ins/byte,    0.287 cycle/byte,   10.824 GB/s (2.4 %),     3.108 GHz,    1.093 ins/cycle 
   0.314 ins/char,    0.287 cycle/char,   10.824 Gc/s (2.4 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  32.026 ins/byte,    6.018 cycle/byte,    0.531 GB/s (0.3 %),     3.193 GHz,    5.322 ins/cycle 
  32.026 ins/char,    6.018 cycle/char,    0.531 Gc/s (0.3 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  54.809 ins/byte,   10.710 cycle/byte,    0.298 GB/s (8.6 %),     3.193 GHz,    5.117 ins/cycle 
  54.809 ins/char,   10.710 cycle/char,    0.298 Gc/s (8.6 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   1.189 ins/byte,    0.303 cycle/byte,   10.577 GB/s (3.0 %),     3.206 GHz,    3.922 ins/cycle 
   1.189 ins/char,    0.303 cycle/char,   10.577 Gc/s (3.0 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.626 ins/byte,    0.358 cycle/byte,    8.944 GB/s (1.7 %),     3.203 GHz,    1.748 ins/cycle 
   0.626 ins/char,    0.358 cycle/char,    8.944 Gc/s (1.7 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.314 ins/byte,    0.353 cycle/byte,    8.795 GB/s (2.3 %),     3.102 GHz,    0.890 ins/cycle 
   0.314 ins/char,    0.353 cycle/char,    8.795 Gc/s (2.3 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  32.025 ins/byte,    6.024 cycle/byte,    0.530 GB/s (0.4 %),     3.193 GHz,    5.316 ins/cycle 
  32.025 ins/char,    6.024 cycle/char,    0.530 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  54.804 ins/byte,   10.708 cycle/byte,    0.298 GB/s (9.1 %),     3.193 GHz,    5.118 ins/cycle 
  54.804 ins/char,   10.708 cycle/char,    0.298 Gc/s (9.1 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   1.189 ins/byte,    0.369 cycle/byte,    8.683 GB/s (2.0 %),     3.201 GHz,    3.224 ins/cycle 
   1.189 ins/char,    0.369 cycle/char,    8.683 Gc/s (2.0 %)     1.00 byte/char  */

/* std::pair<const char*, char32_t*> avx512_convert_latin1_to_utf32(const char* buf, size_t len, char32_t* utf32_output) {
    size_t rounded_len = len & ~0x1F;  // Round down to nearest multiple of 32

    for (size_t i = 0; i < rounded_len; i += 32) {
        // Load 32 Latin1 characters into a 256-bit register
        __m256i in256 = _mm256_loadu_si256((__m256i*)&buf[i]);

        // Extract the lower and upper 128 bits
        __m128i in_low = _mm256_extracti128_si256(in256, 0);
        __m128i in_high = _mm256_extracti128_si256(in256, 1);

        // Zero-extend each set of 16 Latin1 characters to 16 32-bit integers
        __m512i out_low = _mm512_cvtepu8_epi32(in_low);
        __m512i out_high = _mm512_cvtepu8_epi32(in_high);

        // Store the results back to memory
        _mm512_storeu_si512((__m512i*)&utf32_output[i], out_low);
        _mm512_storeu_si512((__m512i*)&utf32_output[i + 16], out_high);
    }

    return std::make_pair(buf + rounded_len, utf32_output + rounded_len);
}
 */

// prefetching is just much slower.
/* std::pair<const char*, char32_t*> avx512_convert_latin1_to_utf32(const char* buf, size_t len, char32_t* utf32_output) {
    size_t rounded_len = len & ~0xF;  // Round down to nearest multiple of 16
    
    for (size_t i = 0; i < rounded_len; i += 16) {
        // Prefetch the next chunk of data into the L1 cache
        // You'll need to adjust the offset based on your access pattern and CPU cache latency
        _mm_prefetch(buf + i + 16, _MM_HINT_T0); // Prefetch into L1 cache

        // Load 16 Latin1 characters into a 128-bit register
        __m128i in = _mm_loadu_si128((__m128i*)&buf[i]);

        // Zero extend each set of 8 Latin1 characters to 16 32-bit integers using vpmovzxbd
        __m512i out = _mm512_cvtepu8_epi32(in);
        
        // Store the results back to memory
        _mm512_storeu_si512((__m512i*)&utf32_output[i], out);
    }

    // Return pointers pointing to where we left off
    return std::make_pair(buf + rounded_len, utf32_output + rounded_len);
} */


/* convert_latin1_to_utf32+haswell, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.628 ins/byte,    0.373 cycle/byte,    8.610 GB/s (38.3 %),     3.210 GHz,    1.684 ins/cycle 
   0.628 ins/char,    0.373 cycle/char,    8.610 Gc/s (38.3 %)     1.00 byte/char 
WARNING: Measurements are noisy, try increasing iteration count (-I).
convert_latin1_to_utf32+icelake, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   0.255 ins/byte,    0.272 cycle/byte,   11.457 GB/s (16.6 %),     3.114 GHz,    0.938 ins/cycle 
   0.255 ins/char,    0.272 cycle/char,   11.457 Gc/s (16.6 %)     1.00 byte/char 
WARNING: Measurements are noisy, try increasing iteration count (-I).
convert_latin1_to_utf32+iconv, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  32.031 ins/byte,    6.020 cycle/byte,    0.531 GB/s (0.4 %),     3.194 GHz,    5.321 ins/cycle 
  32.031 ins/char,    6.020 cycle/char,    0.531 Gc/s (0.4 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
  54.839 ins/byte,   10.694 cycle/byte,    0.299 GB/s (7.6 %),     3.193 GHz,    5.128 ins/cycle 
  54.839 ins/char,   10.694 cycle/char,    0.299 Gc/s (7.6 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 82168, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/esperanto.latin1.txt
   1.191 ins/byte,    0.253 cycle/byte,   12.723 GB/s (4.9 %),     3.217 GHz,    4.712 ins/cycle 
   1.191 ins/char,    0.253 cycle/char,   12.723 Gc/s (4.9 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.626 ins/byte,    0.624 cycle/byte,    5.121 GB/s (2.1 %),     3.196 GHz,    1.002 ins/cycle 
   0.626 ins/char,    0.624 cycle/char,    5.121 Gc/s (2.1 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   0.251 ins/byte,    0.529 cycle/byte,    5.852 GB/s (1.9 %),     3.098 GHz,    0.474 ins/cycle 
   0.251 ins/char,    0.529 cycle/char,    5.852 Gc/s (1.9 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  32.024 ins/byte,    6.036 cycle/byte,    0.529 GB/s (0.6 %),     3.193 GHz,    5.306 ins/cycle 
  32.024 ins/char,    6.036 cycle/char,    0.529 Gc/s (0.6 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
  54.797 ins/byte,   10.703 cycle/byte,    0.298 GB/s (9.1 %),     3.189 GHz,    5.120 ins/cycle 
  54.797 ins/char,   10.703 cycle/char,    0.298 Gc/s (9.1 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 432305, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/french.latin1.txt
   1.188 ins/byte,    0.522 cycle/byte,    6.119 GB/s (1.1 %),     3.196 GHz,    2.275 ins/cycle 
   1.188 ins/char,    0.522 cycle/char,    6.119 Gc/s (1.1 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.626 ins/byte,    0.253 cycle/byte,   12.639 GB/s (2.1 %),     3.203 GHz,    2.472 ins/cycle 
   0.626 ins/char,    0.253 cycle/char,   12.639 Gc/s (2.1 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   0.252 ins/byte,    0.253 cycle/byte,   12.269 GB/s (1.9 %),     3.105 GHz,    0.994 ins/cycle 
   0.252 ins/char,    0.253 cycle/char,   12.269 Gc/s (1.9 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  32.026 ins/byte,    6.019 cycle/byte,    0.531 GB/s (0.5 %),     3.193 GHz,    5.321 ins/cycle 
  32.026 ins/char,    6.019 cycle/char,    0.531 Gc/s (0.5 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
  54.808 ins/byte,   10.697 cycle/byte,    0.298 GB/s (7.9 %),     3.193 GHz,    5.124 ins/cycle 
  54.808 ins/char,   10.697 cycle/char,    0.298 Gc/s (7.9 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 199331, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/german.latin1.txt
   1.189 ins/byte,    0.272 cycle/byte,   11.778 GB/s (3.7 %),     3.208 GHz,    4.365 ins/cycle 
   1.189 ins/char,    0.272 cycle/char,   11.778 Gc/s (3.7 %)     1.00 byte/char 
input detected as unknown
current system detected as icelake
===========================
convert_latin1_to_utf32+haswell, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.626 ins/byte,    0.356 cycle/byte,    8.983 GB/s (2.2 %),     3.200 GHz,    1.757 ins/cycle 
   0.626 ins/char,    0.356 cycle/char,    8.983 Gc/s (2.2 %)     1.00 byte/char 
convert_latin1_to_utf32+icelake, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   0.252 ins/byte,    0.356 cycle/byte,    8.721 GB/s (2.5 %),     3.101 GHz,    0.708 ins/cycle 
   0.252 ins/char,    0.356 cycle/char,    8.721 Gc/s (2.5 %)     1.00 byte/char 
convert_latin1_to_utf32+iconv, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  32.025 ins/byte,    6.034 cycle/byte,    0.529 GB/s (0.5 %),     3.193 GHz,    5.307 ins/cycle 
  32.025 ins/char,    6.034 cycle/char,    0.529 Gc/s (0.5 %)     1.00 byte/char 
convert_latin1_to_utf32+icu, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
  54.803 ins/byte,   10.703 cycle/byte,    0.298 GB/s (8.7 %),     3.193 GHz,    5.120 ins/cycle 
  54.803 ins/char,   10.703 cycle/char,    0.298 Gc/s (8.7 %)     1.00 byte/char 
convert_latin1_to_utf32+westmere, input size: 271743, iterations: 30000, dataset: /home/leorio/unicode_lipsum/wikipedia_mars/portuguese.latin1.txt
   1.189 ins/byte,    0.371 cycle/byte,    8.619 GB/s (2.4 %),     3.201 GHz,    3.201 ins/cycle 
   1.189 ins/char,    0.371 cycle/char,    8.619 Gc/s (2.4 %)     1.00 byte/char  */

std::pair<const char*, char32_t*> avx512_convert_latin1_to_utf32(const char* buf, size_t len, char32_t* utf32_output) {
    size_t rounded_len = len & ~0x3F;  // Round down to nearest multiple of 64

    for (size_t i = 0; i < rounded_len; i += 64) {
        // Load 64 Latin1 characters into a 512-bit register
        __m512i in = _mm512_loadu_si512((__m512i*)&buf[i]);

        // Separate the data into chunks of 16 bytes (128 bits)
        __m128i chunk1 = _mm512_extracti32x4_epi32(in, 0);
        __m128i chunk2 = _mm512_extracti32x4_epi32(in, 1);
        __m128i chunk3 = _mm512_extracti32x4_epi32(in, 2);
        __m128i chunk4 = _mm512_extracti32x4_epi32(in, 3);

        // Zero extend each chunk and store it
        __m512i out1 = _mm512_cvtepu8_epi32(chunk1);
        _mm512_storeu_si512((__m512i*)&utf32_output[i], out1);

        __m512i out2 = _mm512_cvtepu8_epi32(chunk2);
        _mm512_storeu_si512((__m512i*)&utf32_output[i + 16], out2);

        __m512i out3 = _mm512_cvtepu8_epi32(chunk3);
        _mm512_storeu_si512((__m512i*)&utf32_output[i + 32], out3);

        __m512i out4 = _mm512_cvtepu8_epi32(chunk4);
        _mm512_storeu_si512((__m512i*)&utf32_output[i + 48], out4);
    }

    // Return pointers pointing to where we left off
    return std::make_pair(buf + rounded_len, utf32_output + rounded_len);
}
